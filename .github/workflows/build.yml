name: Build Android APK

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.7
        
    - name: Install Cython
      run: pip install Cython
      
    - name: Install Buildozer  
      run: pip install buildozer
    
    - name: Update NDK/SDK
      run: |
        buildozer android update sdk --no-ui
        buildozer android update ndk --no-ui
        
    - name: Install Android Build Tools
      run: |
        sdkmanager "platforms;android-30"
        sdkmanager "build-tools;30.0.3"
      env:
        ACCEPT_LICENSES: "android-sdk-preview-license=.+|android-sdk-license=.+"
        
    - name: Build Android APK
      run: buildozer -v android debug
        
    - name: Upload APK Artifact
      if: ${{ failure() }}  
      uses: actions/upload-artifact@v2
      with:
        name: app-debug
        path: ./bin/myapp-0.1-debug.apk
              
    - name: Upload Log Artifact
      if: ${{ failure() }}
      uses: actions/upload-artifact@v2
      with:
        name: build-logs
        path: .buildozer/android/platform/build.log
